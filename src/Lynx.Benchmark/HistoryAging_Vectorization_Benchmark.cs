/*
 *
 *  BenchmarkDotNet v0.15.8, Linux Ubuntu 24.04.3 LTS (Noble Numbat)
 *  Intel Xeon Platinum 8370C CPU 2.80GHz (Max: 2.79GHz), 1 CPU, 4 logical and 2 physical cores
 *  .NET SDK 10.0.101
 *    [Host]     : .NET 10.0.1 (10.0.1, 10.0.125.57005), X64 RyuJIT x86-64-v4
 *    DefaultJob : .NET 10.0.1 (10.0.1, 10.0.125.57005), X64 RyuJIT x86-64-v4
 *  
 *  | Method                                           | Mean     | Error     | StdDev    | Median   | Ratio | RatioSD | Allocated | Alloc Ratio |
 *  |------------------------------------------------- |---------:|----------:|----------:|---------:|------:|--------:|----------:|------------:|
 *  | Naive                                            | 2.925 us | 0.0555 us | 0.0865 us | 2.876 us |  1.00 |    0.04 |         - |          NA |
 *  | TemporaryVariable                                | 3.053 us | 0.0595 us | 0.0835 us | 3.029 us |  1.04 |    0.04 |         - |          NA |
 *  | ManuallyVectorized                               | 2.547 us | 0.0022 us | 0.0020 us | 2.546 us |  0.87 |    0.02 |         - |          NA |
 *  | ManuallyVectorizedWithTemporaryVariable          | 2.355 us | 0.0029 us | 0.0025 us | 2.354 us |  0.81 |    0.02 |         - |          NA |
 *  | ManuallyVectorizedWithTemporaryVariableAndFixed  | 2.312 us | 0.0028 us | 0.0022 us | 2.311 us |  0.79 |    0.02 |         - |          NA |
 *  | ManuallyVectorizedWithTemporaryVariableAndFixed2 | 1.921 us | 0.0023 us | 0.0020 us | 1.921 us |  0.66 |    0.02 |         - |          NA |
 *  
 *  
 *  
 *  BenchmarkDotNet v0.15.8, Windows 11 (10.0.26100.7462/24H2/2024Update/HudsonValley) (Hyper-V)
 *  AMD EPYC 7763 2.44GHz, 1 CPU, 4 logical and 2 physical cores
 *  .NET SDK 10.0.101
 *    [Host]     : .NET 10.0.1 (10.0.1, 10.0.125.57005), X64 RyuJIT x86-64-v3
 *    DefaultJob : .NET 10.0.1 (10.0.1, 10.0.125.57005), X64 RyuJIT x86-64-v3
 *  
 *  | Method                                           | Mean     | Error     | StdDev    | Ratio | Allocated | Alloc Ratio |
 *  |------------------------------------------------- |---------:|----------:|----------:|------:|----------:|------------:|
 *  | Naive                                            | 3.428 us | 0.0074 us | 0.0066 us |  1.00 |         - |          NA |
 *  | TemporaryVariable                                | 2.935 us | 0.0033 us | 0.0029 us |  0.86 |         - |          NA |
 *  | ManuallyVectorized                               | 2.994 us | 0.0026 us | 0.0020 us |  0.87 |         - |          NA |
 *  | ManuallyVectorizedWithTemporaryVariable          | 2.734 us | 0.0139 us | 0.0124 us |  0.80 |         - |          NA |
 *  | ManuallyVectorizedWithTemporaryVariableAndFixed  | 2.685 us | 0.0081 us | 0.0072 us |  0.78 |         - |          NA |
 *  | ManuallyVectorizedWithTemporaryVariableAndFixed2 | 2.413 us | 0.0031 us | 0.0027 us |  0.70 |         - |          NA |
 *  
 *  
 *   BenchmarkDotNet v0.15.8, macOS Sequoia 15.7.3 (24G419) [Darwin 24.6.0]
 *  Intel Core i7-8700B CPU 3.20GHz (Max: 3.19GHz) (Coffee Lake), 1 CPU, 4 logical and 4 physical cores
 *  .NET SDK 10.0.101
 *    [Host]     : .NET 10.0.1 (10.0.1, 10.0.125.57005), X64 RyuJIT x86-64-v3
 *    DefaultJob : .NET 10.0.1 (10.0.1, 10.0.125.57005), X64 RyuJIT x86-64-v3
 *  
 *  | Method                                           | Mean     | Error     | StdDev    | Ratio | Allocated | Alloc Ratio |
 *  |------------------------------------------------- |---------:|----------:|----------:|------:|----------:|------------:|
 *  | Naive                                            | 2.903 us | 0.0104 us | 0.0093 us |  1.00 |         - |          NA |
 *  | TemporaryVariable                                | 2.725 us | 0.0205 us | 0.0171 us |  0.94 |         - |          NA |
 *  | ManuallyVectorized                               | 2.908 us | 0.0164 us | 0.0137 us |  1.00 |         - |          NA |
 *  | ManuallyVectorizedWithTemporaryVariable          | 3.107 us | 0.0271 us | 0.0240 us |  1.07 |         - |          NA |
 *  | ManuallyVectorizedWithTemporaryVariableAndFixed  | 2.418 us | 0.0170 us | 0.0151 us |  0.83 |         - |          NA |
 *  | ManuallyVectorizedWithTemporaryVariableAndFixed2 | 2.164 us | 0.0159 us | 0.0141 us |  0.75 |         - |          NA |
 *  
 *  For BenchmarkDotNet v0.15.8, macOS Sequoia 15.7.2 (24G325) [Darwin 24.6.0] - Apple M1 (Virtual)
 *  Fatal error.
 *  System.AccessViolationException: Attempted to read or write protected memory. This is often an indication that other memory is corrupt.
 *     at Lynx.Benchmark.HistoryAging_Vectorization_Benchmark.ManuallyVectorizedWithTemporaryVariableAndFixed()
 *     at BenchmarkDotNet.Autogenerated.Runnable_4.WorkloadActionNoUnroll(Int64)
 *     at BenchmarkDotNet.Engines.Engine.Measure(System.Action`1<Int64>, Int64)
 *     at BenchmarkDotNet.Engines.Engine.RunIteration(BenchmarkDotNet.Engines.IterationData)
 *     at BenchmarkDotNet.Engines.EngineFactory.Jit(BenchmarkDotNet.Engines.Engine, Int32, Int32, Int32)
 *     at BenchmarkDotNet.Engines.EngineFactory.CreateReadyToRun(BenchmarkDotNet.Engines.EngineParameters)
 *     at BenchmarkDotNet.Autogenerated.Runnable_4.Run(BenchmarkDotNet.Engines.IHost, System.String)
 * 
*/

using BenchmarkDotNet.Attributes;

namespace Lynx.Benchmark;

public class HistoryAging_Vectorization_Benchmark : BaseBenchmark
{
    /// <summary>
    /// 12 * 64 * 2 * 2 
    /// </summary>
    private const int QuietHistoryLength = 3_072;

    private readonly short[] _quietHistory = GC.AllocateArray<short>(QuietHistoryLength, pinned: true);

    [Benchmark(Baseline = true)]
    public void Naive()
    {
        for (int i = 0; i < QuietHistoryLength; ++i)
        {
            _quietHistory[i] = (short)(_quietHistory[i] * 3 / 4);
        }
    }

    [Benchmark]
    public void TemporaryVariable()
    {
        for (int i = 0; i < QuietHistoryLength; ++i)
        {
            int tmp = _quietHistory[i] * 3;
            _quietHistory[i] = (short)(tmp / 4);
        }
    }

    [Benchmark]
    public void ManuallyVectorized()
    {
        for (int i = 0; i < QuietHistoryLength; i += 4)
        {
            _quietHistory[i] = (short)(_quietHistory[i] * 3 / 4);
            _quietHistory[i + 1] = (short)(_quietHistory[i + 1] * 3 / 4);
            _quietHistory[i + 2] = (short)(_quietHistory[i + 2] * 3 / 4);
            _quietHistory[i + 3] = (short)(_quietHistory[i + 3] * 3 / 4);
        }
    }

    [Benchmark]
    public void ManuallyVectorizedWithTemporaryVariable()
    {
        for (int i = 0; i < QuietHistoryLength; i += 4)
        {
            int tmp1 = _quietHistory[i] * 3;
            int tmp2 = _quietHistory[i + 1] * 3;
            int tmp3 = _quietHistory[i + 2] * 3;
            int tmp4 = _quietHistory[i + 3] * 3;

            _quietHistory[i] = (short)(tmp1 / 4);
            _quietHistory[i + 1] = (short)(tmp2 / 4);
            _quietHistory[i + 2] = (short)(tmp3 / 4);
            _quietHistory[i + 3] = (short)(tmp4 / 4);
        }
    }

    [Benchmark]
    public unsafe void ManuallyVectorizedWithTemporaryVariableAndFixed()
    {
        fixed (short* histPtr = _quietHistory)
        {
            for (int i = 0; i < QuietHistoryLength; i += 4)
            {
                var start = histPtr + i;

                int tmp1 = *start * 3;
                int tmp2 = *(start + 1) * 3;
                int tmp3 = *(start + 2) * 3;
                int tmp4 = *(start + 3) * 3;

                _quietHistory[i] = (short)(tmp1 / 4);
                _quietHistory[i + 1] = (short)(tmp2 / 4);
                _quietHistory[i + 2] = (short)(tmp3 / 4);
                _quietHistory[i + 3] = (short)(tmp4 / 4);
            }
        }
    }

    [Benchmark]
    public unsafe void ManuallyVectorizedWithTemporaryVariableAndFixed2()
    {
        fixed (short* histPtr = _quietHistory)
        {
            for (int i = 0; i < QuietHistoryLength; i += 4)
            {
                var start = histPtr + i;

                short* h2 = start + 1;
                short* h3 = start + 2;
                short* h4 = start + 3;

                int tmp1 = *start * 3;
                int tmp2 = *h2 * 3;
                int tmp3 = *h3 * 3;
                int tmp4 = *h4 * 3;

                *start = (short)(tmp1 / 4);
                *h2 = (short)(tmp2 / 4);
                *h3 = (short)(tmp3 / 4);
                *h4 = (short)(tmp4 / 4);
            }
        }
    }

    [Benchmark]
    public unsafe void ManuallyVectorizedWithTemporaryVariableAndFixed2_Length8()
    {
        fixed (short* histPtr = _quietHistory)
        {
            for (int i = 0; i < QuietHistoryLength; i += 8)
            {
                var start = histPtr + i;

                short* h2 = start + 1;
                short* h3 = start + 2;
                short* h4 = start + 3;
                short* h5 = start + 4;
                short* h6 = start + 5;
                short* h7 = start + 6;
                short* h8 = start + 7;

                int tmp1 = *start * 3;
                int tmp2 = *h2 * 3;
                int tmp3 = *h3 * 3;
                int tmp4 = *h4 * 3;
                int tmp5 = *h5 * 3;
                int tmp6 = *h6 * 3;
                int tmp7 = *h7 * 3;
                int tmp8 = *h8 * 3;

                *start = (short)(tmp1 / 4);
                *h2 = (short)(tmp2 / 4);
                *h3 = (short)(tmp3 / 4);
                *h4 = (short)(tmp4 / 4);
                *h5 = (short)(tmp5 / 4);
                *h6 = (short)(tmp6 / 4);
                *h7 = (short)(tmp7 / 4);
                *h8 = (short)(tmp8 / 4);
            }
        }
    }
}
